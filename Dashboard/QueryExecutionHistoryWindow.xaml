<Window x:Class="PerformanceMonitorDashboard.QueryExecutionHistoryWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:converters="clr-namespace:PerformanceMonitorDashboard.Converters"
        xmlns:ScottPlot="clr-namespace:ScottPlot.WPF;assembly=ScottPlot.WPF"
        Title="Query Execution History" Height="900" Width="1400"
        WindowStartupLocation="CenterOwner"
        Background="{DynamicResource BackgroundBrush}">
    <Window.Resources>
        <converters:NullToBooleanConverter x:Key="NullToBooleanConverter"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="2*" MinHeight="250"/>
            <RowDefinition Height="3*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Grid.Row="0" Background="{DynamicResource BackgroundLightBrush}" Padding="10" Margin="10,10,10,0">
            <StackPanel>
                <TextBlock x:Name="QueryIdentifierText" FontSize="16" FontWeight="Bold" Foreground="{DynamicResource ForegroundBrush}"/>
                <TextBlock x:Name="SummaryText" Margin="0,5,0,0" Foreground="{DynamicResource ForegroundBrush}"/>
            </StackPanel>
        </Border>

        <!-- Chart Area -->
        <Border Grid.Row="1" Background="{DynamicResource BackgroundLightBrush}" Margin="10,10,10,0" Padding="10">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Chart Controls -->
                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                    <TextBlock Text="Metric:" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundBrush}" Margin="0,0,8,0"/>
                    <ComboBox x:Name="MetricSelector" Width="200" SelectionChanged="MetricSelector_SelectionChanged">
                        <ComboBoxItem Content="Avg Duration (ms)" Tag="AvgDurationMs" IsSelected="True"/>
                        <ComboBoxItem Content="Avg CPU (ms)" Tag="AvgCpuTimeMs"/>
                        <ComboBoxItem Content="Avg Logical Reads" Tag="AvgLogicalReads"/>
                        <ComboBoxItem Content="Avg Logical Writes" Tag="AvgLogicalWrites"/>
                        <ComboBoxItem Content="Avg Physical Reads" Tag="AvgPhysicalReads"/>
                        <ComboBoxItem Content="Avg Memory (MB)" Tag="AvgMemoryMb"/>
                        <ComboBoxItem Content="Avg Rows" Tag="AvgRowcount"/>
                        <ComboBoxItem Content="Executions" Tag="CountExecutions"/>
                    </ComboBox>
                    <TextBlock x:Name="ChartLegendText" Margin="20,0,0,0" VerticalAlignment="Center" Foreground="{DynamicResource ForegroundDimBrush}" FontSize="11"/>
                </StackPanel>

                <!-- Chart -->
                <ScottPlot:WpfPlot x:Name="HistoryChart" Grid.Row="1"/>
            </Grid>
        </Border>

        <!-- Data Grid -->
        <DataGrid Grid.Row="2" x:Name="HistoryDataGrid"
                  AutoGenerateColumns="False"
                  IsReadOnly="True"
                  CanUserSortColumns="True"
                  AlternatingRowBackground="{DynamicResource BackgroundLightBrush}"
                  Background="{DynamicResource BackgroundBrush}"
                  Foreground="{DynamicResource ForegroundBrush}"
                  RowBackground="{DynamicResource BackgroundBrush}"
                  GridLinesVisibility="All"
                  RowHeight="30"
                  Margin="10">
            <DataGrid.Columns>
                <!-- Collection Info -->
                <DataGridTextColumn Header="Collection Time" Binding="{Binding CollectionTime, StringFormat='{}{0:yyyy-MM-dd HH:mm:ss}'}" Width="150"/>
                <DataGridTextColumn Header="Plan ID" Binding="{Binding PlanId}" Width="70"/>
                <DataGridTextColumn Header="Executions" Binding="{Binding CountExecutions, StringFormat=N0}" Width="90"/>

                <!-- Duration (ms) -->
                <DataGridTextColumn Header="Avg Duration (ms)" Binding="{Binding AvgDurationMs, StringFormat=N2}" Width="115"/>
                <DataGridTextColumn Header="Min Duration (ms)" Binding="{Binding MinDurationMs, StringFormat=N2}" Width="115"/>
                <DataGridTextColumn Header="Max Duration (ms)" Binding="{Binding MaxDurationMs, StringFormat=N2}" Width="115"/>

                <!-- CPU (ms) -->
                <DataGridTextColumn Header="Avg CPU (ms)" Binding="{Binding AvgCpuTimeMs, StringFormat=N2}" Width="100"/>
                <DataGridTextColumn Header="Min CPU (ms)" Binding="{Binding MinCpuTimeMs, StringFormat=N2}" Width="100"/>
                <DataGridTextColumn Header="Max CPU (ms)" Binding="{Binding MaxCpuTimeMs, StringFormat=N2}" Width="100"/>

                <!-- Logical Reads -->
                <DataGridTextColumn Header="Avg Logical Reads" Binding="{Binding AvgLogicalReads, StringFormat=N0}" Width="115"/>
                <DataGridTextColumn Header="Min Logical Reads" Binding="{Binding MinLogicalReads, StringFormat=N0}" Width="115"/>
                <DataGridTextColumn Header="Max Logical Reads" Binding="{Binding MaxLogicalReads, StringFormat=N0}" Width="115"/>

                <!-- Logical Writes -->
                <DataGridTextColumn Header="Avg Logical Writes" Binding="{Binding AvgLogicalWrites, StringFormat=N0}" Width="115"/>
                <DataGridTextColumn Header="Min Logical Writes" Binding="{Binding MinLogicalWrites, StringFormat=N0}" Width="115"/>
                <DataGridTextColumn Header="Max Logical Writes" Binding="{Binding MaxLogicalWrites, StringFormat=N0}" Width="115"/>

                <!-- Physical Reads -->
                <DataGridTextColumn Header="Avg Physical Reads" Binding="{Binding AvgPhysicalReads, StringFormat=N0}" Width="120"/>
                <DataGridTextColumn Header="Min Physical Reads" Binding="{Binding MinPhysicalReads, StringFormat=N0}" Width="120"/>
                <DataGridTextColumn Header="Max Physical Reads" Binding="{Binding MaxPhysicalReads, StringFormat=N0}" Width="120"/>

                <!-- DOP -->
                <DataGridTextColumn Header="Min DOP" Binding="{Binding MinDop}" Width="70"/>
                <DataGridTextColumn Header="Max DOP" Binding="{Binding MaxDop}" Width="70"/>

                <!-- Memory (MB) -->
                <DataGridTextColumn Header="Avg Memory (MB)" Binding="{Binding AvgMemoryMb, StringFormat=N2}" Width="115"/>
                <DataGridTextColumn Header="Min Memory (MB)" Binding="{Binding MinMemoryMb, StringFormat=N2}" Width="115"/>
                <DataGridTextColumn Header="Max Memory (MB)" Binding="{Binding MaxMemoryMb, StringFormat=N2}" Width="115"/>

                <!-- Row Count -->
                <DataGridTextColumn Header="Avg Rows" Binding="{Binding AvgRowcount, StringFormat=N0}" Width="90"/>
                <DataGridTextColumn Header="Min Rows" Binding="{Binding MinRowcount, StringFormat=N0}" Width="90"/>
                <DataGridTextColumn Header="Max Rows" Binding="{Binding MaxRowcount, StringFormat=N0}" Width="90"/>

                <!-- TempDB (MB) -->
                <DataGridTextColumn Header="Avg TempDB (MB)" Binding="{Binding AvgTempdbMb, StringFormat=N2}" Width="115"/>
                <DataGridTextColumn Header="Min TempDB (MB)" Binding="{Binding MinTempdbMb, StringFormat=N2}" Width="115"/>
                <DataGridTextColumn Header="Max TempDB (MB)" Binding="{Binding MaxTempdbMb, StringFormat=N2}" Width="115"/>

                <!-- Plan Info -->
                <DataGridTextColumn Header="Plan Type" Binding="{Binding PlanType}" Width="100"/>
                <DataGridCheckBoxColumn Header="Forced" Binding="{Binding IsForcedPlan}" Width="60"/>
                <DataGridTextColumn Header="Force Failures" Binding="{Binding ForceFailureCount}" Width="100"/>
                <DataGridTextColumn Header="Last Failure Reason" Binding="{Binding LastForceFailureReasonDesc}" Width="150"/>
                <DataGridTextColumn Header="Forcing Type" Binding="{Binding PlanForcingType}" Width="100"/>
                <DataGridTextColumn Header="Compat Level" Binding="{Binding CompatibilityLevel}" Width="90"/>

                <!-- Download Plan Button -->
                <DataGridTemplateColumn Header="Query Plan" Width="Auto" MinWidth="90">
                    <DataGridTemplateColumn.CellTemplate>
                        <DataTemplate>
                            <Button Content="Download" Click="DownloadPlan_Click"
                                    IsEnabled="{Binding QueryPlanXml, Converter={StaticResource NullToBooleanConverter}}"
                                    HorizontalAlignment="Center" VerticalAlignment="Center"
                                    Padding="8,4"/>
                        </DataTemplate>
                    </DataGridTemplateColumn.CellTemplate>
                </DataGridTemplateColumn>
            </DataGrid.Columns>
        </DataGrid>

        <!-- Footer -->
        <Border Grid.Row="3" Background="{DynamicResource BackgroundLightBrush}" Padding="10" Margin="10,0,10,10">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <Button Content="Close" Width="100" Height="30" Click="Close_Click"/>
            </StackPanel>
        </Border>
    </Grid>
</Window>
